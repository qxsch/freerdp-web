
                                    ┌───────────────────────────────────────────────┐
                                    │              REGION Block                     │
                                    │   • Tile list                                 │
                                    │   • progQuant / quantVals                     │
                                    │   • Extrapolate                               │
                                    │   • FIRST / UPGRADE pass                      │
                                    └───────────────────────────────────────────────┘
                                                      │
                                                      ▼
                         ┌────────────────────────────────────────────────────────────┐
                         │   Codec Params Same as Previous Frame? (progQuant, etc.)   │
                         └────────────────────────────────────────────────────────────┘
                                   │ Yes                               │ No
                                   ▼                                   ▼
             ┌───────────────────────────────────────┐   ┌─────────────────────────────────────────┐
             │  Keep Progressive State               │   │ Reset Progressive Codec State           │
             │  (Continue refinement)                │   │ • Clear coefficient buffers             │
             └───────────────────────────────────────┘   │ • Reset LL3/LL2/LL1                     │
                                    │                    │ • Drop refinement history               │
                                    ▼                    └─────────────────────────────────────────┘
                       ┌───────────────────────────────────┐                       │
                       │   TILE_FIRST ?                    │<──────────────────────┘
                       └───────────────────────────────────┘
                           │ Yes                      │ No (UPGRADE)
                           ▼                          ▼
   ┌──────────────────────────────────────────┐   ┌───────────────────────────────────────────┐
   │ Decode FIRST_TILE                        │   │ Decode UPGRADE_TILE                       │
   │ • Build LL3 baseline                     │   │ • Add/replace coeffs                      │
   │ • Apply REGION.extrapolate               │   │ • Requires tile.valid = true              │
   │ • tile.valid = true                      │   └───────────────────────────────────────────┘
   └──────────────────────────────────────────┘                           │
                                                                          ▼
                                                   ┌──────────────────────────────────────────┐
                                                   │ tile.valid ?                             │
                                                   └──────────────────────────────────────────┘
                                                      │ Yes                     │ No
                                                      ▼                         ▼
                 ┌───────────────────────────────────────────────┐   ┌──────────────────────────────┐
                 │ Update Coeff Buffers (refinement OK)          │   │ Skip UPGRADE (invalid tile)  │
                 └───────────────────────────────────────────────┘   └──────────────────────────────┘
                                   │
                                   ▼
                    ┌────────────────────────────────────┐
                    │ Inverse DWT → RGBA tile data       │
                    └────────────────────────────────────┘
                                   │
                                   ▼
           ┌──────────────────────────────────────────────────────────┐
           │ Write RGBA tile data into Surface Tile Cache (64x64 px)  │
           └──────────────────────────────────────────────────────────┘
                                   │
                                   ▼
           ┌──────────────────────────────────────────────────────────┐
           │ Render Surface via MapSurfaceToOutput                    │
           └──────────────────────────────────────────────────────────┘
                                   │
                                   ▼
           ┌──────────────────────────────────────────────────────────┐
           │ Composite All Surfaces to Final Frame                    │
           └──────────────────────────────────────────────────────────┘
                                   │
                                   ▼
           ┌──────────────────────────────────────────────────────────┐
           │ FRAME_END → Output WebP / Display Output                 │
           └──────────────────────────────────────────────────────────┘










┌─────────────────────────────────────────────────────────────────────────────┐
│                        WIRE_TO_SURFACE (Progressive)                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Progressive WASM Decoder (progressive_wasm.c)                              │
│  ─────────────────────────────────────────────────────────────────────────  │
│  1. RLGR decode → coefficients                                              │
│  2. Dequantize → scaled coefficients                                        │
│  3. IDWT → Y'CbCr pixels                                                    │
│  4. rfx_ycbcr_to_rgba() → tile->data (RGBA)  ◄── FULLY DECODED              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  Surface (OffscreenCanvas)                                                  │
│  putImageData(tile->data, tileX, tileY)                                     │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
          ┌─────────────────────────┴─────────────────────────┐
          │                                                   │
          ▼                                                   ▼
┌──────────────────────────┐                    ┌──────────────────────────────┐
│  SURFACE_TO_CACHE        │                    │  Direct render to screen     │
│  ─────────────────────── │                    └──────────────────────────────┘
│  getImageData() → RGBA   │
│  bitmapCache.set(slot,   │
│    { imageData })        │
└──────────────────────────┘
          │
          │  (cache persists)
          │
          ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│  bitmapCache (Map<slot, {imageData, sourceSurface, ...}>)                    │
│  ──────────────────────────────────────────────────────────────────────────  │
│  • Stores DECODED RGBA pixels (codec-agnostic)                               │
│  • Lifetime: Until EVICT_CACHE_ENTRY PDU                                     │
│  • Survives surface delete/recreate                                          │
│  • sourceSurface field is INFORMATIONAL ONLY                                 │
└──────────────────────────────────────────────────────────────────────────────┘
          │
          ▼
┌──────────────────────────┐
│  CACHE_TO_SURFACE        │
│  ─────────────────────── │
│  entry = cache.get(slot) │
│  putImageData(entry, x,y)│
└──────────────────────────┘



